; ============================================
;  Core PHP settings for Moodle performance
; ============================================

; RAM cho PHP (Moodle cần nhiều bộ nhớ hơn WordPress)
memory_limit = 512M

; Upload cho file lớn (bài giảng, SCORM, backup)
upload_max_filesize = 2000M
post_max_size = 2000M

; Thời gian thực thi (backup/restore cần lâu)
max_execution_time = 300
max_input_time = 300

; Moodle yêu cầu tối thiểu 5000
max_input_vars = 5000

; Fix các giới hạn khi xử lý import, backup lớn
max_input_nesting_level = 64
max_input_time = 300

; Ngăn lỗi random extension timeout
default_socket_timeout = 60

; ============================================
;  OPcache – BẮT BUỘC cho Production
; ============================================

opcache.enable=1
opcache.enable_cli=1
opcache.memory_consumption=256
opcache.interned_strings_buffer=16
opcache.max_accelerated_files=10000
opcache.revalidate_freq=1
opcache.validate_timestamps=1
opcache.save_comments=1
opcache.fast_shutdown=1

; Tắt file cache trong Docker (không cần)
opcache.file_cache=

; ============================================
;   Session handling (chuẩn Moodle)
; ============================================

session.auto_start = 0
session.gc_maxlifetime = 14400  ; 4 giờ
session.save_handler = files

; Nếu dùng Redis session thì đổi:
; session.save_handler = redis
; session.save_path = "tcp://redis:6379"

; ============================================
;  Các cấu hình bắt buộc khác
; ============================================

; Tránh lỗi large POST
request_order = "GP"

; Ngăn lỗi khi Moodle đọc input lớn
realpath_cache_size = 4096K
realpath_cache_ttl = 600

; Tối ưu “slash arguments” (Moodle yêu cầu)
cgi.fix_pathinfo = 0

; Cho Moodle CLI (cron, upgrade) không thiếu RAM
cli_server.color = 0

; ============================================
;  Logging (cho production hoặc debug)
; ============================================

log_errors = On
error_log = /var/log/php-error.log
display_errors = Off  ; bật = On khi cần debug

; ============================================
;  mysqli - tăng số kết nối và timeout
; ============================================

mysqli.reconnect = On
mysqli.allow_local_infile = On
mysqli.default_socket = /var/run/mysqld/mysqld.sock
mysql.connect_timeout = 10
